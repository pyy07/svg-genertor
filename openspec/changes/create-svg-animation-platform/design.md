# Design: SVG 动画生成平台

## Context

构建一个基于 Next.js 的 Web 应用，通过 Google Gemini 3.0 API 将用户的自然语言描述转换为 SVG 动画代码。由于 API 调用有成本和使用限制，需要实现访问控制机制。同时需要支持微信登录以降低用户使用门槛。

## Goals / Non-Goals

### Goals
- 提供简洁的用户界面，用户输入一句话即可生成 SVG 动画
- 实现密码保护机制，控制 API 调用成本
- 支持微信登录，提升用户体验
- 持久化保存所有生成的素材
- 部署到 Vercel，支持自动化 CI/CD

### Non-Goals
- 不实现用户注册/邮箱登录（仅支持微信登录）
- 不实现素材编辑功能（仅生成和查看）
- 不实现素材分享功能（初始版本）

## Decisions

### Decision: 使用 Next.js App Router
- **理由**: Next.js 提供完整的 React 框架，支持 SSR/SSG，易于部署到 Vercel
- **替代方案**: Remix, SvelteKit - 选择 Next.js 因为与 Vercel 集成最佳

### Decision: 使用 Google Gemini 3.0 API
- **理由**: 用户明确要求使用 Google AI Studio 的 API key 和 Gemini 3.0 模型
- **替代方案**: OpenAI GPT, Claude - 已由用户指定

### Decision: 用户使用次数限制系统设计
- **默认用户**: 每个登录用户默认可以使用 3 次 SVG 生成功能
- **永久用户**: 管理员可以设置某些用户为永久用户，无使用次数限制
- **理由**: 基于用户身份的限制更简单，无需在每次生成时输入密码，提升用户体验

### Decision: 数据库选择
- **选项**: PostgreSQL (Vercel Postgres), MongoDB, SQLite
- **选择**: Vercel Postgres（如果可用）或 Supabase（PostgreSQL）
- **理由**: 与 Vercel 集成良好，支持关系型数据（密码、素材、用户关联）

### Decision: 素材存储
- **选项**: 数据库存储 SVG 代码，文件系统存储，对象存储（S3/Vercel Blob）
- **选择**: 数据库存储 SVG 代码 + 元数据，考虑未来迁移到对象存储
- **理由**: 初始版本简单，SVG 代码通常较小，数据库足够；未来可扩展

### Decision: 微信登录实现
- **选项**: 微信开放平台 OAuth 2.0，微信扫码登录
- **选择**: 微信开放平台网页授权（OAuth 2.0）
- **理由**: 标准 OAuth 流程，Next.js 有成熟的集成方案

## Risks / Trade-offs

### Risk: API 调用成本控制
- **风险**: 用户滥用或大量注册导致 API 调用超限
- **缓解**: 
  - 实现用户使用次数限制（默认 3 次）
  - 要求微信登录，增加注册门槛
  - 监控 API 调用频率
  - 考虑添加 rate limiting

### Risk: 微信登录审核
- **风险**: 微信开放平台需要审核，可能延迟上线
- **缓解**: 
  - 初期可先实现密码登录，微信登录作为后续功能
  - 或使用测试账号进行开发

### Risk: 素材存储成本
- **风险**: 大量生成的素材占用存储空间
- **缓解**: 
  - 初始版本使用数据库存储（小文件）
  - 未来可迁移到对象存储，添加清理策略

### Trade-off: 用户使用次数管理复杂度
- **简单方案**: 硬编码用户使用次数限制
- **复杂方案**: 数据库存储用户使用次数，支持动态管理
- **选择**: 数据库存储用户使用次数，支持管理员通过界面管理用户权限

## Migration Plan

### Phase 1: 基础框架
1. 初始化 Next.js 项目
2. 配置 Vercel 部署
3. 设置环境变量（API keys）

### Phase 2: 核心功能
1. 实现密码认证系统
2. 集成 Gemini API
3. 实现 SVG 生成功能

### Phase 3: 用户功能
1. 集成微信登录
2. 实现素材存储和查看

### Phase 4: 优化和部署
1. 添加错误处理和日志
2. 性能优化
3. 生产环境部署

## Open Questions

- [ ] 微信登录是否需要企业认证？
- [ ] 素材是否需要支持下载功能？
- [ ] 是否需要实现素材搜索和分类？
- [ ] API 调用是否需要添加缓存机制？

